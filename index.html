<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <title>Controle Financeiro - Estilo Monefy</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />

  <!-- Google Fonts -->
  <link rel="preconnect" href="https://fonts.googleapis.com" />
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
  <link
    href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600&family=Rubik:wght@500;700&display=swap"
    rel="stylesheet"
  />

  <style>
    * {
      box-sizing: border-box;
      font-family: "Inter", system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
    }
    body {
      margin: 0;
      padding: 16px;
      background:
        radial-gradient(circle at top, #0f172a 0, #020617 55%) fixed,
        linear-gradient(135deg, #22c55e11, #6366f111);
      color: #e5e7eb;
      min-height: 100vh;
    }
    body.card-expanded-mode {
      overflow: hidden;
    }
    .container {
      max-width: 1100px;
      margin: 0 auto;
      position: relative;
      z-index: 1;
    }

    .scroll-overlay {
      position: fixed;
      inset: 0;
      pointer-events: none;
      background: radial-gradient(circle at top, rgba(15,23,42,0) 0, rgba(0,0,0,0.9) 75%);
      opacity: 0;
      transition: opacity 0.35s ease-out;
      z-index: 0;
    }
    body.card-expanded-mode #scrollOverlay {
      opacity: 0 !important;
    }

    .card-expand-overlay {
      position: fixed;
      inset: 0;
      background: rgba(0,0,0,0.55);
      display: none;
      z-index: 60;
    }

    h1 {
      font-family: "Rubik", system-ui, sans-serif;
      font-size: 22px;
      margin: 0 0 6px;
      text-align: center;
    }
    h2 {
      font-family: "Rubik", system-ui, sans-serif;
      font-size: 16px;
      margin: 16px 0 8px;
    }
    .small {
      font-size: 11px;
      color: #9ca3af;
      margin-bottom: 8px;
      text-align: center;
    }

    .mes-ref {
      display: flex;
      align-items: center;
      gap: 6px;
      font-size: 11px;
      color: #9ca3af;
      margin-bottom: 6px;
      flex-wrap: wrap;
      justify-content: center;
    }
    .mes-ref-input {
      background: #020617;
      border: 1px solid #374151;
      border-radius: 999px;
      padding: 3px 8px;
      font-size: 11px;
      color: #e5e7eb;
      min-width: 120px;
    }
    .mes-ref-input:focus {
      outline: 1px solid #22c55e;
      border-color: #22c55e;
    }

    .tabs-bar {
      display: flex;
      gap: 8px;
      margin: 8px 0 12px;
      background: #020617;
      padding: 4px;
      border-radius: 999px;
      border: 1px solid #111827;
    }
    .tab-btn {
      flex: 1;
      text-align: center;
      border-radius: 999px;
      border: none;
      padding: 6px 10px;
      font-size: 12px;
      cursor: pointer;
      background: transparent;
      color: #9ca3af;
      font-family: "Rubik", system-ui, sans-serif;
      transition: transform 0.16s ease, box-shadow 0.16s ease, background 0.16s ease, color 0.16s ease;
    }
    .tab-btn:hover {
      transform: translateY(-1px);
      box-shadow: 0 8px 18px rgba(0,0,0,0.55);
    }
    .tab-btn.active {
      background: linear-gradient(135deg, #22c55e, #4ade80);
      color: #022c22;
      font-weight: 600;
    }
    .tab-panel {
      display: none;
    }
    .tab-panel.active {
      display: block;
    }

    .grid {
      display: grid;
      grid-template-columns: 1fr;
      gap: 16px;
    }
    .card {
      background: radial-gradient(circle at top left, #020617 0, #020617 55%);
      border-radius: 16px;
      padding: 12px 14px;
      border: 1px solid #111827;
      box-shadow: 0 10px 25px rgba(0,0,0,0.55);
      transition: transform 0.2s ease, box-shadow 0.2s ease, border-color 0.2s ease, background 0.2s ease;
    }
    .card-emphasis {
      background: radial-gradient(circle at top left, #111827 0, #020617 60%);
      border-color: #22c55e55;
    }

    .card-expandable {
      cursor: pointer;
      position: relative;
    }
    .card-expandable:hover {
      transform: translateY(-2px) scale(1.01);
      box-shadow: 0 14px 30px rgba(0,0,0,0.7);
      border-color: #22c55e88;
    }
    .card-expanded {
      position: fixed;
      top: 40px;
      left: 50%;
      transform: translateX(-50%);
      width: min(720px, 100% - 32px);
      max-height: calc(100vh - 80px);
      overflow-y: auto;
      z-index: 70;

      background: #020617;
      border-color: #22c55eaa;
      box-shadow: 0 24px 60px rgba(0,0,0,0.9);
    }
    .card-expand-close {
      display: none;
    }
    .card-expanded .card-expand-close {
      display: flex;
      justify-content: flex-end;
      margin-bottom: 4px;
    }

    .badge {
      font-size: 11px;
      text-transform: uppercase;
      letter-spacing: 0.08em;
      color: #9ca3af;
      margin-bottom: 8px;
    }
    .row {
      display: flex;
      flex-direction: column;
      gap: 8px;
    }
    .row > div {
      flex: 1;
    }

    label {
      display: block;
      font-size: 12px;
      margin-bottom: 2px;
      color: #9ca3af;
    }
    input[type="number"],
    input[type="text"],
    select {
      width: 100%;
      padding: 6px 8px;
      border-radius: 10px;
      border: 1px solid #1f2937;
      background: #020617;
      color: #e5e7eb;
      font-size: 13px;
    }
    input:focus,
    select:focus {
      outline: 1px solid #22c55e;
      border-color: #22c55e;
      box-shadow: 0 0 0 1px rgba(34, 197, 94, 0.5);
    }

    button {
      border-radius: 999px;
      border: none;
      padding: 7px 14px;
      font-size: 12px;
      cursor: pointer;
      white-space: nowrap;
      transition: transform 0.16s ease, box-shadow 0.16s ease, filter 0.16s ease, background 0.16s ease, border-color 0.16s ease;
    }
    button:hover {
      transform: translateY(-1px);
      box-shadow: 0 8px 18px rgba(0,0,0,0.55);
    }
    button:active {
      transform: translateY(0);
      box-shadow: 0 3px 10px rgba(0,0,0,0.6);
      filter: brightness(0.95);
    }

    .btn-main {
      background: linear-gradient(135deg, #22c55e, #4ade80);
      color: #022c22;
      font-weight: 600;
    }
    .btn-main:hover {
      background: linear-gradient(135deg, #22c55e, #16a34a);
    }
    .btn-main:active {
      background: linear-gradient(135deg, #16a34a, #15803d);
    }

    .btn-ghost {
      background: transparent;
      border: 1px solid #374151;
      color: #e5e7eb;
    }

    .toolbar {
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
      margin: 8px 0 12px;
    }

    .kpi-label {
      font-size: 11px;
      color: #9ca3af;
    }
    .kpi-value {
      font-size: 20px;
      font-weight: 600;
      font-family: "Rubik", system-ui, sans-serif;
    }
    .kpi-pos {
      color: #4ade80;
    }
    .kpi-neg {
      color: #f97373;
    }
    .kpi-neutral {
      color: #38bdf8;
    }

    .fluxo-dia {
      border-top: 1px solid #111827;
      padding-top: 8px;
      margin-top: 8px;
    }
    .fluxo-header {
      display: flex;
      justify-content: space-between;
      font-size: 13px;
      margin-bottom: 4px;
      gap: 8px;
    }
    .fluxo-sub {
      font-size: 11px;
      color: #9ca3af;
      margin-bottom: 4px;
    }
    .fluxo-valores {
      font-size: 12px;
    }
    .plus {
      color: #4ade80;
      font-weight: 600;
    }
    .minus {
      color: #f97373;
      font-weight: 600;
    }
    .equal {
      color: #38bdf8;
      font-weight: 600;
    }

    .list {
      font-size: 12px;
      margin-top: 6px;
      max-height: 200px;
      overflow-y: auto;
      border-top: 1px solid #111827;
      padding-top: 4px;
    }
    .list-item {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 4px;
      gap: 6px;
    }
    .pill {
      font-size: 10px;
      padding: 2px 6px;
      border-radius: 999px;
      background: #1f2937;
      color: #e5e7eb;
    }
    .remove-btn {
      background: transparent;
      border: 1px solid #4b5563;
      color: #9ca3af;
      border-radius: 999px;
      padding: 2px 6px;
      font-size: 10px;
      cursor: pointer;
    }

    .totais-mini {
      font-size: 11px;
      color: #9ca3af;
      margin-top: 6px;
    }

    .chart-wrapper {
      display: flex;
      justify-content: center;
      align-items: center;
      margin-top: 8px;
    }
    #resumoChart {
      max-width: 180px;
      max-height: 180px;
    }

    .fab {
      position: fixed;
      right: 16px;
      bottom: 16px;
      width: 52px;
      height: 52px;
      border-radius: 50%;
      background: linear-gradient(135deg, #22c55e, #4ade80);
      color: #022c22;
      border: none;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 26px;
      font-weight: 700;
      box-shadow: 0 12px 30px rgba(0, 0, 0, 0.6);
      z-index: 40;
      cursor: pointer;
      transition: transform 0.18s ease, box-shadow 0.18s ease, filter 0.18s ease;
    }
    body.card-expanded-mode .fab {
      display: none;
    }
    .fab span { margin-top: -2px; }
    .fab:hover {
      transform: translateY(-2px) scale(1.03);
      box-shadow: 0 14px 32px rgba(0,0,0,0.7);
    }
    .fab:active {
      transform: translateY(0) scale(0.97);
      filter: brightness(0.96);
    }

    .quick-panel {
      position: fixed;
      left: 12px;
      right: 12px;
      bottom: 76px;
      background: #020617;
      border-radius: 16px;
      border: 1px solid #111827;
      box-shadow: 0 10px 30px rgba(0, 0, 0, 0.7);
      padding: 10px 12px;
      z-index: 39;
      display: none;
    }
    body.card-expanded-mode .quick-panel {
      display: none !important;
    }
    .quick-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 6px;
      font-size: 12px;
    }
    .quick-title {
      font-family: "Rubik", system-ui, sans-serif;
      font-size: 13px;
    }
    .quick-close {
      border: none;
      background: transparent;
      color: #9ca3af;
      font-size: 16px;
      cursor: pointer;
    }
    .quick-row {
      display: flex;
      gap: 6px;
      margin-bottom: 6px;
    }
    .quick-row > div { flex: 1; }
    .quick-actions {
      display: flex;
      justify-content: flex-end;
      gap: 6px;
      margin-top: 4px;
    }

    @media (min-width: 768px) {
      .grid {
        grid-template-columns: repeat(2, minmax(0, 1fr));
      }
      .row {
        flex-direction: row;
      }
      .fab,
      .quick-panel {
        display: none !important;
      }
    }
    @media (min-width: 1024px) {
      .grid-main {
        display: grid;
        grid-template-columns: 2fr 1.5fr;
        gap: 16px;
      }
    }
  </style>
</head>
<body>
  <div id="scrollOverlay" class="scroll-overlay"></div>
  <div id="cardExpandOverlay" class="card-expand-overlay" onclick="fecharCardExpandido()"></div>

  <div class="container">
    <h1>Controle Financeiro - Estilo Monefy</h1>

    <div class="mes-ref">
      <span>Mês de referência do orçamento:</span>
      <input id="mesReferencia" class="mes-ref-input" value="" />
    </div>

    <div class="small">
      Edite salários, contas, compras e rendas extras e clique em <strong>Recalcular tudo</strong>.
    </div>

    <div class="toolbar">
      <button class="btn-main" onclick="recalcularTudo()">Recalcular tudo</button>
      <button class="btn-ghost" onclick="resetarPadrao()">Voltar valores padrão</button>
      <button class="btn-ghost" onclick="limparMovimentos()">Limpar compras e rendas extras</button>
      <button class="btn-main" onclick="exportarResumo()">Exportar Resumo</button>
      <!-- botão para salvar na planilha -->
      <button class="btn-ghost" onclick="salvarNaPlanilha()">Sincronizar com planilha</button>
    </div>

    <div class="tabs-bar">
      <button class="tab-btn active" data-tab="resumo" onclick="mudarAba('resumo')">Resumo</button>
      <button class="tab-btn" data-tab="movimentos" onclick="mudarAba('movimentos')">Compras &amp; Rendas</button>
    </div>

    <!-- RESUMO -->
    <div id="tab-resumo" class="tab-panel active">
      <div class="grid-main">
        <div>
          <div class="grid">
            <div id="cardVisao" class="card card-emphasis card-expandable" onclick="toggleExpandCard('cardVisao', event)">
              <div class="card-expand-close">
                <button class="btn-ghost" onclick="fecharCardExpandido(event)">Fechar</button>
              </div>
              <div class="badge">Visão geral do mês</div>
              <div class="kpi-label">Renda total (salários + rendas extras)</div>
              <div id="kpiRenda" class="kpi-value kpi-neutral">R$ 0,00</div>

              <div class="kpi-label" style="margin-top:8px;">Gastos fixos + cartão + compras</div>
              <div id="kpiFixos" class="kpi-value kpi-neg">R$ 0,00</div>

              <div class="kpi-label" style="margin-top:8px;">Saldo potencial do mês</div>
              <div id="kpiSaldo" class="kpi-value kpi-pos">R$ 0,00</div>

              <div class="totais-mini">
                Rendas extras: <span id="miniExtras">R$ 0,00</span> · Compras: <span id="miniCompras">R$ 0,00</span>
              </div>

              <div class="chart-wrapper">
                <canvas id="resumoChart" width="190" height="190"></canvas>
              </div>
            </div>

            <div id="cardRenda" class="card card-emphasis card-expandable" onclick="toggleExpandCard('cardRenda', event)">
              <div class="card-expand-close">
                <button class="btn-ghost" onclick="fecharCardExpandido(event)">Fechar</button>
              </div>
              <div class="badge">Configurações de renda</div>
              <div class="row">
                <div>
                  <label>Seu salário - dia 5</label>
                  <input id="sal5" type="number" step="0.01" value="2257.60" onclick="event.stopPropagation()" />
                </div>
                <div>
                  <label>Seu salário - dia 20</label>
                  <input id="sal20" type="number" step="0.01" value="964.77" onclick="event.stopPropagation()" />
                </div>
              </div>
              <div class="row" style="margin-top:6px;">
                <div>
                  <label>Salário esposa - dia 15</label>
                  <input id="sal15" type="number" step="0.01" value="1132.00" onclick="event.stopPropagation()" />
                </div>
                <div>
                  <label>Salário esposa - dia 30</label>
                  <input id="sal30" type="number" step="0.01" value="1300.00" onclick="event.stopPropagation()" />
                </div>
              </div>
            </div>

            <div class="card">
              <div class="badge">Configurações de contas fixas</div>
              <div class="row">
                <div>
                  <label>Aluguel</label>
                  <input id="aluguel" type="number" step="0.01" value="600" />
                </div>
                <div>
                  <label>Internet</label>
                  <input id="internet" type="number" step="0.01" value="90" />
                </div>
              </div>
              <div class="row" style="margin-top:6px;">
                <div>
                  <label>Vivo</label>
                  <input id="vivo" type="number" step="0.01" value="50" />
                </div>
                <div>
                  <label>Água</label>
                  <input id="agua" type="number" step="0.01" value="80" />
                </div>
              </div>
              <div class="row" style="margin-top:6px;">
                <div>
                  <label>Luz (valor do mês)</label>
                  <input id="luz" type="number" step="0.01" value="57" />
                </div>
                <div>
                  <label>Cartão de crédito (mês)</label>
                  <input id="cartao" type="number" step="0.01" value="912.12" />
                </div>
              </div>
              <div class="row" style="margin-top:6px;">
                <div>
                  <label>Parcela do carro</label>
                  <input id="carro" type="number" step="0.01" value="840" />
                </div>
                <div>
                  <label>Seguro da moto</label>
                  <input id="seguro" type="number" step="0.01" value="103" />
                </div>
              </div>
            </div>
          </div>

          <h2>Fluxo de Caixa - Acompanhamento por Data</h2>
          <div class="card">
            <div id="fluxoDia5" class="fluxo-dia"></div>
            <div id="fluxoDia15" class="fluxo-dia"></div>
            <div id="fluxoDia20" class="fluxo-dia"></div>
            <div id="fluxoDia30" class="fluxo-dia"></div>
          </div>
        </div>

        <div></div>
      </div>
    </div>

    <!-- MOVIMENTOS -->
    <div id="tab-movimentos" class="tab-panel">
      <div class="grid">
        <div class="card">
          <div class="badge">Rendas extras</div>
          <div class="row">
            <div>
              <label>Descrição</label>
              <input id="extraDesc" type="text" placeholder="Freela, venda, pix, etc." />
            </div>
            <div>
              <label>Valor (R$)</label>
              <input id="extraValor" type="number" step="0.01" />
            </div>
          </div>
          <div style="margin-top:8px; display:flex; justify-content:flex-end;">
            <button class="btn-main" onclick="adicionarExtra()">Adicionar renda extra</button>
          </div>
          <div class="totais-mini">
            Total de rendas extras: <span id="totalExtras">R$ 0,00</span>
          </div>
          <div id="listaExtras" class="list"></div>
        </div>

        <div class="card">
          <div class="badge">Compras e gastos do dia a dia</div>

          <div class="row" style="margin-bottom:6px;">
            <div>
              <label>Filtrar por descrição</label>
              <input id="filtroCompraTexto" type="text" placeholder="Buscar (ex.: mercado, gasolina)" oninput="renderCompras()" />
            </div>
          </div>
          <div class="row" style="margin-bottom:6px;">
            <div>
              <label>Filtrar por categoria</label>
              <select id="filtroCompraCategoria" onchange="renderCompras()">
                <option value="">Todas</option>
                <option value="Mercado">Mercado</option>
                <option value="Transporte">Transporte</option>
                <option value="Lazer">Lazer</option>
                <option value="Saúde">Saúde</option>
                <option value="Outros">Outros</option>
              </select>
            </div>
          </div>

          <div class="row">
            <div>
              <label>Descrição</label>
              <input id="compraDesc" type="text" placeholder="Mercado, gasolina, lanche..." />
            </div>
          </div>
          <div class="row" style="margin-top:6px;">
            <div>
              <label>Categoria</label>
              <select id="compraCategoria">
                <option value="Mercado">Mercado</option>
                <option value="Transporte">Transporte</option>
                <option value="Lazer">Lazer</option>
                <option value="Saúde">Saúde</option>
                <option value="Outros">Outros</option>
              </select>
            </div>
            <div>
              <label>Valor (R$)</label>
              <input id="compraValor" type="number" step="0.01" />
            </div>
          </div>
          <div style="margin-top:8px; display:flex; justify-content:flex-end;">
            <button class="btn-main" onclick="adicionarCompra()">Adicionar compra</button>
          </div>
          <div class="totais-mini">
            Total de compras (mês): <span id="totalCompras">R$ 0,00</span><br />
            Total exibido no filtro: <span id="totalComprasFiltrado">R$ 0,00</span>
          </div>
          <div id="listaCompras" class="list"></div>
        </div>
      </div>
    </div>
  </div>

  <div id="quickPanel" class="quick-panel">
    <div class="quick-header">
      <div class="quick-title">Lançamento rápido</div>
      <button class="quick-close" onclick="fecharLancamentoRapido()">×</button>
    </div>
    <div class="quick-row">
      <div>
        <label>Tipo</label>
        <select id="qTipo" onchange="atualizarQuickTipo()">
          <option value="compra">Compra</option>
          <option value="extra">Renda extra</option>
        </select>
      </div>
      <div id="qCategoriaWrap">
        <label>Categoria</label>
        <select id="qCategoria">
          <option value="Mercado">Mercado</option>
          <option value="Transporte">Transporte</option>
          <option value="Lazer">Lazer</option>
          <option value="Saúde">Saúde</option>
          <option value="Outros">Outros</option>
        </select>
      </div>
    </div>
    <div class="quick-row">
      <div>
        <label>Descrição</label>
        <input id="qDesc" type="text" placeholder="Ex.: Mercado, pix extra..." />
      </div>
    </div>
    <div class="quick-row">
      <div>
        <label>Valor (R$)</label>
        <input id="qValor" type="number" step="0.01" />
      </div>
    </div>
    <div class="quick-actions">
      <button class="btn-ghost" onclick="fecharLancamentoRapido()">Cancelar</button>
      <button class="btn-main" onclick="salvarLancamentoRapido()">Salvar</button>
    </div>
  </div>

  <button class="fab" onclick="toggleLancamentoRapido()">
    <span>+</span>
  </button>

  <script>
    let extras = [];
    let compras = [];

    /* COLE AQUI SUA URL DO WEB APP DO APPS SCRIPT */
    const WEBAPP_URL = "https://script.google.com/macros/s/AKfycbzaEkdVkE6uWOiQOD8oN-eCF6FE0hp-xvuJLLbnMJXRijC9lRCP77DFgOxTr8y-zDq9ag/exec";

    function lerNumero(id) {
      const el = document.getElementById(id);
      if (!el) return 0;
      const texto = String(el.value).replace(",", ".");
      const n = parseFloat(texto);
      return isNaN(n) ? 0 : n;
    }

    function moeda(v) {
      return v.toLocaleString("pt-BR", { style: "currency", currency: "BRL" });
    }

    function totalExtras() {
      return extras.reduce((s, e) => s + e.valor, 0);
    }

    function totalCompras() {
      return compras.reduce((s, c) => s + c.valor, 0);
    }

    /* Estado completo para enviar à planilha */
    function montarEstado() {
      return {
        mesReferencia: document.getElementById("mesReferencia")?.value || "",
        salarios: {
          sal5: document.getElementById("sal5")?.value || "",
          sal15: document.getElementById("sal15")?.value || "",
          sal20: document.getElementById("sal20")?.value || "",
          sal30: document.getElementById("sal30")?.value || ""
        },
        contas: {
          aluguel: document.getElementById("aluguel")?.value || "",
          internet: document.getElementById("internet")?.value || "",
          vivo: document.getElementById("vivo")?.value || "",
          agua: document.getElementById("agua")?.value || "",
          luz: document.getElementById("luz")?.value || "",
          cartao: document.getElementById("cartao")?.value || "",
          carro: document.getElementById("carro")?.value || "",
          seguro: document.getElementById("seguro")?.value || ""
        },
        extras,
        compras
      };
    }

    async function salvarNaPlanilha() {
      if (!WEBAPP_URL || WEBAPP_URL === "COLE_SUA_URL_AQUI") {
        alert("Configure a constante WEBAPP_URL com a URL do seu Web App.");
        return;
      }
      try {
        const estado = montarEstado();
        const resp = await fetch(WEBAPP_URL, {
          method: "POST",
          headers: {
            "Content-Type": "application/json"
          },
          body: JSON.stringify(estado)
        });
        const data = await resp.json();
        console.log("Salvo na planilha:", data);
        alert("Dados sincronizados com a planilha.");
      } catch (e) {
        console.error("Erro ao salvar na planilha:", e);
        alert("Erro ao salvar na planilha. Veja o console.");
      }
    }

    async function carregarDaPlanilha() {
      if (!WEBAPP_URL || WEBAPP_URL === "COLE_SUA_URL_AQUI") return;
      try {
        const resp = await fetch(WEBAPP_URL + "?t=" + Date.now());
        const data = await resp.json();
        if (!data || data.ok === false) {
          console.log("Nenhum estado na planilha ainda:", data);
          return;
        }
        const estado = data;

        if (estado.mesReferencia && document.getElementById("mesReferencia")) {
          document.getElementById("mesReferencia").value = estado.mesReferencia;
        }

        if (estado.salarios) {
          if (document.getElementById("sal5"))  document.getElementById("sal5").value  = estado.salarios.sal5  ?? "";
          if (document.getElementById("sal15")) document.getElementById("sal15").value = estado.salarios.sal15 ?? "";
          if (document.getElementById("sal20")) document.getElementById("sal20").value = estado.salarios.sal20 ?? "";
          if (document.getElementById("sal30")) document.getElementById("sal30").value = estado.salarios.sal30 ?? "";
        }

        if (estado.contas) {
          if (document.getElementById("aluguel"))  document.getElementById("aluguel").value  = estado.contas.aluguel  ?? "";
          if (document.getElementById("internet")) document.getElementById("internet").value = estado.contas.internet ?? "";
          if (document.getElementById("vivo"))     document.getElementById("vivo").value     = estado.contas.vivo     ?? "";
          if (document.getElementById("agua"))     document.getElementById("agua").value     = estado.contas.agua     ?? "";
          if (document.getElementById("luz"))      document.getElementById("luz").value      = estado.contas.luz      ?? "";
          if (document.getElementById("cartao"))   document.getElementById("cartao").value   = estado.contas.cartao   ?? "";
          if (document.getElementById("carro"))    document.getElementById("carro").value    = estado.contas.carro    ?? "";
          if (document.getElementById("seguro"))   document.getElementById("seguro").value   = estado.contas.seguro   ?? "";
        }

        extras = Array.isArray(estado.extras) ? estado.extras : [];
        compras = Array.isArray(estado.compras) ? estado.compras : [];

        renderExtras();
        renderCompras();
        recalcularTudo();
      } catch (e) {
        console.error("Erro ao carregar da planilha:", e);
      }
    }

    function atualizarMesReferenciaAutomatico() {
      const el = document.getElementById("mesReferencia");
      if (!el) return;
      const agora = new Date();
      const texto = agora.toLocaleDateString("pt-BR", {
        month: "long",
        year: "numeric"
      });
      const textoFormatado = texto.charAt(0).toUpperCase() + texto.slice(1);
      if (!el.value) el.value = textoFormatado;
    }

    function atualizarEscurecimentoScroll() {
      const overlay = document.getElementById("scrollOverlay");
      if (!overlay) return;
      const doc = document.documentElement;
      const maxScroll = doc.scrollHeight - window.innerHeight;
      if (maxScroll <= 0) {
        overlay.style.opacity = 0;
        return;
      }
      const progresso = window.scrollY / maxScroll;
      const opacidade = Math.min(0.75, progresso * 0.9);
      overlay.style.opacity = opacidade;
    }
    window.addEventListener("scroll", atualizarEscurecimentoScroll);
    window.addEventListener("resize", atualizarEscurecimentoScroll);

    function desenharGrafico(resumo) {
      const canvas = document.getElementById("resumoChart");
      if (!canvas) return;
      const ctx = canvas.getContext("2d");
      const { gastos, saldo } = resumo;

      const total = Math.max(gastos + saldo, 1);
      const cx = canvas.width / 2;
      const cy = canvas.height / 2;
      const raioExterno = Math.min(cx, cy) - 4;
      const raioInterno = raioExterno * 0.55;

      ctx.clearRect(0, 0, canvas.width, canvas.height);

      let inicio = -Math.PI / 2;

      const angGastos = (gastos / total) * Math.PI * 2;
      ctx.beginPath();
      ctx.moveTo(cx, cy);
      ctx.arc(cx, cy, raioExterno, inicio, inicio + angGastos);
      ctx.closePath();
      ctx.fillStyle = "#f97373";
      ctx.fill();
      inicio += angGastos;

      const angSaldo = (saldo / total) * Math.PI * 2;
      ctx.beginPath();
      ctx.moveTo(cx, cy);
      ctx.arc(cx, cy, raioExterno, inicio, inicio + angSaldo);
      ctx.closePath();
      ctx.fillStyle = "#22c55e";
      ctx.fill();

      ctx.globalCompositeOperation = "destination-out";
      ctx.beginPath();
      ctx.arc(cx, cy, raioInterno, 0, Math.PI * 2);
      ctx.fill();
      ctx.globalCompositeOperation = "source-over";

      ctx.fillStyle = "#e5e7eb";
      ctx.font = "500 12px Inter, system-ui, -apple-system";
      ctx.textAlign = "center";
      ctx.textBaseline = "middle";
      ctx.fillText("Gastos x Saldo", cx, cy - 10);
      ctx.font = "600 13px Rubik, system-ui";
      ctx.fillText(moeda(saldo), cx, cy + 8);
    }

    function recalcularTudo() {
      const sal5 = lerNumero("sal5");
      const sal15 = lerNumero("sal15");
      const sal20 = lerNumero("sal20");
      const sal30 = lerNumero("sal30");

      const aluguel = lerNumero("aluguel");
      const internet = lerNumero("internet");
      const vivo = lerNumero("vivo");
      const agua = lerNumero("agua");
      const luz = lerNumero("luz");
      const cartao = lerNumero("cartao");
      const carro = lerNumero("carro");
      const seguro = lerNumero("seguro");

      const extrasTotal = totalExtras();
      const comprasTotal = totalCompras();

      const rendaTotal = sal5 + sal15 + sal20 + sal30 + extrasTotal;
      const gastosFixos = aluguel + internet + vivo + agua + luz + cartao + carro + seguro;
      const gastosGerais = gastosFixos + comprasTotal;
      const saldoPotencial = rendaTotal - gastosGerais;

      document.getElementById("kpiRenda").textContent = moeda(rendaTotal);
      document.getElementById("kpiFixos").textContent = moeda(gastosGerais);
      document.getElementById("kpiSaldo").textContent = moeda(saldoPotencial);
      document.getElementById("miniExtras").textContent = moeda(extrasTotal);
      document.getElementById("miniCompras").textContent = moeda(comprasTotal);

      desenharGrafico({ gastos: gastosGerais, saldo: Math.max(saldoPotencial, 0) });

      const gastosDia5 = aluguel + internet + vivo + agua + luz + cartao;
      const sobraDia5 = sal5 - gastosDia5;

      const gastosDia15 = 0;
      const sobraDia15 = sal15 - gastosDia15;

      const gastosDia20 = carro;
      const sobraDia20 = sal20 - gastosDia20;

      const gastosDia30 = seguro;
      const sobraDia30 = sal30 - gastosDia30;

      document.getElementById("fluxoDia5").innerHTML = `
        <div class="fluxo-header">
          <div><span style="color:#f97316;font-weight:600;">DIA 5</span> · Seu salário chega</div>
          <div class="kpi-neutral">${moeda(sal5)}</div>
        </div>
        <div class="fluxo-sub">Renda do titular</div>
        <div class="fluxo-sub">
          Gastos: Aluguel (${moeda(aluguel)}), Luz (${moeda(luz)}),
          Água (${moeda(agua)}), Internet (${moeda(internet)}),
          Vivo (${moeda(vivo)}), Cartão (${moeda(cartao)})
        </div>
        <div class="fluxo-valores">
          <span class="plus">+ ${moeda(sal5)}</span>
          &nbsp; | &nbsp;
          <span class="minus">- ${moeda(gastosDia5)}</span>
          &nbsp; | &nbsp;
          <span class="equal">= ${moeda(sobraDia5)}</span>
        </div>
      `;

      document.getElementById("fluxoDia15").innerHTML = `
        <div class="fluxo-header">
          <div><span style="color:#f97316;font-weight:600;">DIA 15</span> · Salário da esposa chega</div>
          <div class="kpi-neutral">${moeda(sal15)}</div>
        </div>
        <div class="fluxo-sub">Mercado, transporte, dia a dia</div>
        <div class="fluxo-valores">
          <span class="plus">+ ${moeda(sal15)}</span>
          &nbsp; | &nbsp;
          <span class="minus">- ${moeda(gastosDia15)}</span>
          &nbsp; | &nbsp;
          <span class="equal">= ${moeda(sobraDia15)}</span>
        </div>
      `;

      document.getElementById("fluxoDia20").innerHTML = `
        <div class="fluxo-header">
          <div><span style="color:#f97316;font-weight:600;">DIA 20</span> · Seu segundo salário chega</div>
          <div class="kpi-neutral">${moeda(sal20)}</div>
        </div>
        <div class="fluxo-sub">Parcela do carro</div>
        <div class="fluxo-valores">
          <span class="plus">+ ${moeda(sal20)}</span>
          &nbsp; | &nbsp;
          <span class="minus">- ${moeda(gastosDia20)}</span>
          &nbsp; | &nbsp;
          <span class="equal">= ${moeda(sobraDia20)}</span>
        </div>
      `;

      document.getElementById("fluxoDia30").innerHTML = `
        <div class="fluxo-header">
          <div><span style="color:#f97316;font-weight:600;">DIA 30</span> · Último salário da esposa chega</div>
          <div class="kpi-neutral">${moeda(sal30)}</div>
        </div>
        <div class="fluxo-sub">Seguro da moto + reserva</div>
        <div class="fluxo-valores">
          <span class="plus">+ ${moeda(sal30)}</span>
          &nbsp; | &nbsp;
          <span class="minus">- ${moeda(gastosDia30)}</span>
          &nbsp; | &nbsp;
          <span class="equal">= ${moeda(sobraDia30)}</span>
        </div>
      `;

      atualizarEscurecimentoScroll();
    }

    function resetarPadrao() {
      document.getElementById("sal5").value = "2257.60";
      document.getElementById("sal20").value = "964.77";
      document.getElementById("sal15").value = "1132.00";
      document.getElementById("sal30").value = "1300.00";
      document.getElementById("aluguel").value = "600";
      document.getElementById("internet").value = "90";
      document.getElementById("vivo").value = "50";
      document.getElementById("agua").value = "80";
      document.getElementById("luz").value = "57";
      document.getElementById("cartao").value = "912.12";
      document.getElementById("carro").value = "840";
      document.getElementById("seguro").value = "103";
      recalcularTudo();
    }

    function mudarAba(nome) {
      document.querySelectorAll(".tab-btn").forEach(btn => {
        btn.classList.toggle("active", btn.dataset.tab === nome);
      });
      document.querySelectorAll(".tab-panel").forEach(panel => {
        panel.classList.toggle("active", panel.id === "tab-" + nome);
      });
    }

    function renderExtras() {
      const cont = document.getElementById("listaExtras");
      if (!cont) return;
      cont.innerHTML = "";
      extras.forEach((e, idx) => {
        const div = document.createElement("div");
        div.className = "list-item";
        div.innerHTML = `
          <div>
            <div>${e.desc || "Renda extra"}</div>
            <div class="small">${moeda(e.valor)}</div>
          </div>
          <button class="remove-btn" onclick="removerExtra(${idx})">remover</button>
        `;
        cont.appendChild(div);
      });
      const spanTotal = document.getElementById("totalExtras");
      if (spanTotal) spanTotal.textContent = moeda(totalExtras());
    }

    function adicionarExtra() {
      const desc = document.getElementById("extraDesc")?.value.trim() || "";
      const val = lerNumero("extraValor");
      if (!val || val <= 0) return;
      extras.push({ desc, valor: val });
      document.getElementById("extraDesc").value = "";
      document.getElementById("extraValor").value = "";
      renderExtras();
      recalcularTudo();
    }

    function removerExtra(idx) {
      extras.splice(idx, 1);
      renderExtras();
      recalcularTudo();
    }

    function renderCompras() {
      const cont = document.getElementById("listaCompras");
      if (!cont) return;
      cont.innerHTML = "";

      const filtroTexto = document.getElementById("filtroCompraTexto")?.value.toLowerCase() || "";
      const filtroCat = document.getElementById("filtroCompraCategoria")?.value || "";

      let totalFiltrado = 0;

      compras.forEach((c, idx) => {
        const desc = (c.desc || "Compra").toLowerCase();
        const matchTexto = !filtroTexto || desc.includes(filtroTexto);
        const matchCat = !filtroCat || c.categoria === filtroCat;
        if (!matchTexto || !matchCat) return;

        totalFiltrado += c.valor;

        const div = document.createElement("div");
        div.className = "list-item";
        div.innerHTML = `
          <div>
            <div>${c.desc || "Compra"} <span class="small">(${c.data})</span></div>
            <div class="small">
              <span class="pill">${c.categoria}</span>
              &nbsp; ${moeda(c.valor)}
            </div>
          </div>
          <button class="remove-btn" onclick="removerCompra(${idx})">remover</button>
        `;
        cont.appendChild(div);
      });

      const spanTotal = document.getElementById("totalCompras");
      if (spanTotal) spanTotal.textContent = moeda(totalCompras());

      const spanFiltrado = document.getElementById("totalComprasFiltrado");
      if (spanFiltrado) spanFiltrado.textContent = moeda(totalFiltrado);
    }

    function adicionarCompra() {
      const desc = document.getElementById("compraDesc")?.value.trim() || "";
      const cat = document.getElementById("compraCategoria")?.value || "Outros";
      const val = lerNumero("compraValor");
      if (!val || val <= 0) return;
      const hoje = new Date();
      const data = hoje.toLocaleDateString("pt-BR");
      compras.push({ desc, categoria: cat, valor: val, data });
      document.getElementById("compraDesc").value = "";
      document.getElementById("compraValor").value = "";
      renderCompras();
      recalcularTudo();
    }

    function removerCompra(idx) {
      compras.splice(idx, 1);
      renderCompras();
      recalcularTudo();
    }

    function limparMovimentos() {
      const ok = confirm(
        "Tem certeza que deseja limpar TODAS as compras e rendas extras deste mês? Essa ação não pode ser desfeita."
      );
      if (!ok) return;

      extras = [];
      compras = [];
      renderExtras();
      renderCompras();
      recalcularTudo();
    }

    function exportarResumo() {
      const sal5 = lerNumero("sal5");
      const sal15 = lerNumero("sal15");
      const sal20 = lerNumero("sal20");
      const sal30 = lerNumero("sal30");

      const aluguel = lerNumero("aluguel");
      const internet = lerNumero("internet");
      const vivo = lerNumero("vivo");
      const agua = lerNumero("agua");
      const luz = lerNumero("luz");
      const cartao = lerNumero("cartao");
      const carro = lerNumero("carro");
      const seguro = lerNumero("seguro");

      const extrasTotal = totalExtras();
      const comprasTotal = totalCompras();

      const rendaTotal = sal5 + sal15 + sal20 + sal30 + extrasTotal;
      const gastosFixos = aluguel + internet + vivo + agua + luz + cartao + carro + seguro;
      const gastosGerais = gastosFixos + comprasTotal;

      const categorias = [
        { nome: "Moradia", total: aluguel },
        { nome: "Contas Mensais", total: internet + vivo + agua + luz },
        { nome: "Transporte", total: carro },
        { nome: "Cartão de Crédito", total: cartao },
        { nome: "Seguros", total: seguro },
        { nome: "Compras & Outros", total: comprasTotal }
      ];

      let texto = "Descrição,Valor\n";
      texto += `Total Entradas,${rendaTotal.toFixed(2)}\n`;
      texto += `Total Saidas,${gastosGerais.toFixed(2)}\n\n`;
      texto += "Gastos por Categoria,\nCategoria,Total\n";
      categorias.forEach(g => {
        texto += `${g.nome},${g.total.toFixed(2)}\n`;
      });

      const blob = new Blob([texto], { type: "text/csv" });
      const url = URL.createObjectURL(blob);
      const a = document.createElement("a");
      a.href = url;
      a.download = `Resumo_Financeiro_${new Date().toISOString().slice(0,10)}.csv`;
      a.click();
      URL.revokeObjectURL(url);
    }

    function toggleLancamentoRapido() {
      const p = document.getElementById("quickPanel");
      if (!p) return;
      const visible = p.style.display === "block";
      p.style.display = visible ? "none" : "block";
      if (!visible) {
        document.getElementById("qTipo").value = "compra";
        document.getElementById("qDesc").value = "";
        document.getElementById("qValor").value = "";
        document.getElementById("qCategoria").value = "Mercado";
        atualizarQuickTipo();
      }
    }

    function fecharLancamentoRapido() {
      const p = document.getElementById("quickPanel");
      if (p) p.style.display = "none";
    }

    function atualizarQuickTipo() {
      const tipo = document.getElementById("qTipo").value;
      const wrap = document.getElementById("qCategoriaWrap");
      wrap.style.display = tipo === "compra" ? "block" : "none";
    }

    function salvarLancamentoRapido() {
      const tipo = document.getElementById("qTipo").value;
      const desc = document.getElementById("qDesc").value.trim();
      const valText = String(document.getElementById("qValor").value).replace(",", ".");
      const val = parseFloat(valText);
      if (!val || val <= 0) return;

      if (tipo === "extra") {
        document.getElementById("extraDesc").value = desc;
        document.getElementById("extraValor").value = val.toString();
        adicionarExtra();
      } else {
        const cat = document.getElementById("qCategoria").value || "Outros";
        document.getElementById("compraDesc").value = desc;
        document.getElementById("compraValor").value = val.toString();
        document.getElementById("compraCategoria").value = cat;
        adicionarCompra();
      }

      fecharLancamentoRapido();
    }

    function toggleExpandCard(cardId, ev) {
      if (ev) ev.stopPropagation();
      const card = document.getElementById(cardId);
      const overlay = document.getElementById("cardExpandOverlay");
      if (!card || !overlay) return;

      const isExpanded = card.classList.contains("card-expanded");
      document.querySelectorAll(".card-expanded").forEach(c => c.classList.remove("card-expanded"));

      if (isExpanded) {
        overlay.style.display = "none";
        document.body.classList.remove("card-expanded-mode");
      } else {
        overlay.style.display = "block";
        document.body.classList.add("card-expanded-mode");
        card.classList.add("card-expanded");
      }
    }

    function fecharCardExpandido(ev) {
      if (ev) ev.stopPropagation();
      const overlay = document.getElementById("cardExpandOverlay");
      overlay.style.display = "none";
      document.body.classList.remove("card-expanded-mode");
      document.querySelectorAll(".card-expanded").forEach(c => c.classList.remove("card-expanded"));
    }

    window.addEventListener("load", () => {
      atualizarMesReferenciaAutomatico();
      carregarDaPlanilha();
      atualizarQuickTipo();
      renderExtras();
      renderCompras();
      recalcularTudo();
      mudarAba("resumo");
      atualizarEscurecimentoScroll();
    });
  </script>
</body>
</html>
